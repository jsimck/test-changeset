name: Tag CI

on:
  push:
    tags:
      - '*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tag-info:
    name: Get Tag Information
    runs-on: ubuntu-latest
    outputs:
      current-tag: ${{ steps.tag-info.outputs.current-tag }}
      all-tags: ${{ steps.tag-info.outputs.all-tags }}
      tags-for-commit: ${{ steps.tag-info.outputs.tags-for-commit }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags

      - uses: actions/setup-node@v4
        with:
          cache: 'npm'
          node-version: '24'

      - name: Install Dependencies
        run: npm ci

      - name: Get Tag Information
        id: tag-info
        shell: bash
        run: |
          echo "Getting tag information for CI..."

          # Run the basic script
          echo "=== Basic Tag Info ==="
          node scripts/get-tags.js

          echo -e "\n=== Environment Variables Format ==="
          node scripts/get-tags-advanced.js --format env

          echo -e "\n=== Recent Tags (Last 5) ==="
          node scripts/get-tags-advanced.js --format list --limit 5

          # Set outputs for other jobs
          CURRENT_TAG="${{ github.ref_name }}"
          ALL_TAGS=$(node scripts/get-tags-advanced.js --format csv)
          TAGS_FOR_COMMIT=$(git tag --points-at HEAD | tr '\n' ',' | sed 's/,$//')

          echo "current-tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "all-tags=$ALL_TAGS" >> $GITHUB_OUTPUT
          echo "tags-for-commit=$TAGS_FOR_COMMIT" >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: tag-info
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          cache: 'npm'
          node-version: '24'

      - name: Install Dependencies
        run: npm ci

      - name: Use Tag Information
        shell: bash
        run: |
          echo "Current tag: ${{ needs.tag-info.outputs.current-tag }}"
          echo "Tags for this commit: ${{ needs.tag-info.outputs.tags-for-commit }}"

          # Example: Check if this is a pre-release
          if [[ "${{ needs.tag-info.outputs.current-tag }}" == *"beta"* ]] || [[ "${{ needs.tag-info.outputs.current-tag }}" == *"alpha"* ]]; then
            echo "This is a pre-release tag"
            echo "PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "This is a stable release tag"
            echo "PRERELEASE=false" >> $GITHUB_ENV
          fi

          # Example: Extract version number
          VERSION=$(echo "${{ needs.tag-info.outputs.current-tag }}" | sed 's/^v//')
          echo "Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Project
        run: |
          echo "Building project for tag: ${{ needs.tag-info.outputs.current-tag }}"
          # Add your build commands here
          echo "Build completed successfully"

      - name: Deploy (Production)
        if: env.PRERELEASE == 'false'
        run: |
          echo "Deploying stable release ${{ env.VERSION }} to production"
          # Add your production deployment commands here

      - name: Deploy (Staging)
        if: env.PRERELEASE == 'true'
        run: |
          echo "Deploying pre-release ${{ env.VERSION }} to staging"
          # Add your staging deployment commands here

  changelog-generation:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: tag-info
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          cache: 'npm'
          node-version: '24'

      - name: Install Dependencies
        run: npm ci

      - name: Generate Detailed Tag Report
        shell: bash
        run: |
          echo "Generating detailed tag report..."

          # Generate CSV report with commit info
          node scripts/get-tags-advanced.js \
            --format csv \
            --include-commits \
            --limit 10 \
            --output tag-report.csv

          # Generate filtered release tags only
          node scripts/get-tags-advanced.js \
            --filter "^v[0-9]+\.[0-9]+\.[0-9]+$" \
            --format list \
            --limit 5 \
            --output recent-releases.txt

          echo "Generated reports:"
          ls -la *.csv *.txt

          echo "=== Recent Releases ==="
          cat recent-releases.txt

      - name: Upload Tag Reports
        uses: actions/upload-artifact@v4
        with:
          name: tag-reports
          path: |
            tag-report.csv
            recent-releases.txt
